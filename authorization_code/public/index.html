<!doctype html>
<html>
<head>
  <title>Example of the Authorization Code flow with Spotify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

  <!--todo: does this go here exactly?-->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.js"></script>
  <!--<script type="text/javascript" src="dosearch.js"></script>-->
  <script type="text/javascript" src="artists.js"></script>

  <script src="bundle.js"></script>
  <script src="all_genres2.js"></script>


  <script src="x-directive.multiobject.js"></script>
  <link rel = "stylesheet"
        type = "text/css"
        href = "multi.css" />



  <!--<script type="text/javascript" src="app.js"></script>-->


  <style type="text/css">
    #login, #loggedin {
      display: none;
    }
    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
    .pointer:hover{
      cursor:pointer;
    }

  </style>
</head>

<!--<script src="http://code.angularjs.org/angular-1.0.1.js"></script>-->


<body>
<div class="container"  ng-app="playlistGen">

  <div id="login">
    <!--<h1>This is an example of the Authorization Code flow</h1>-->
    <a href="/login" class="btn btn-primary">Log in with Spotify</a>
  </div>
  <div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>

    <style>

      body {
        background: #eee;
      }

      .card {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300px;
        height: 300px;
        margin: -150px;
        float: left;
        perspective: 500px;
      }

      .content {
        position: absolute;
        width: 100%;
        height: 100%;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);

        transition: transform 1s;
        transform-style: preserve-3d;
      }

      .card:hover .content {
        transform: rotateY( 180deg ) ;
        transition: transform 0.5s;
      }

      .front,
      .back {
        position: absolute;
        height: 100%;
        width: 100%;
        background: white;
        line-height: 300px;
        color: #03446A;
        text-align: center;
        font-size: 60px;
        border-radius: 5px;
        backface-visibility: hidden;
      }

      .back {
        background: #03446A;
        color: white;
        transform: rotateY( 180deg );
      }

      /*tree*/

      #body {
        width: 1200px;
        margin: 0 auto;
        position: relative;
      }

      rect {
        fill: none;
        pointer-events: all;
      }

      pre {
        font-size: 18px;
      }

      line {
        stroke: #0E0;
        stroke-width: 1.5px;
      }

      .string, .regexp {
        color: #f39;
      }

      .keyword {
        color: #00c;
      }

      .comment {
        color: #777;
        font-style: oblique;
      }

      .number {
        color: #369;
      }

      .class, .special {
        color: #1181B8;
      }

      a:link, a:visited {
        color: steelblue;
        text-decoration: none;
      }

      a:hover {
        color: #666;
      }



      .node circle {
        cursor: pointer;
        fill: #fff;
        stroke: steelblue;
        stroke-width: 1.5px;
      }

      .node text {
        font-size: 12px;
      }

      path.link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2.0px;
      }
    </style>


    <!--<div style="display:flex;flex-direction:row;">-->


    <!--<div class="card">-->
    <!--<div class="content">-->
    <!--<div class="front">-->
    <!--Front-->
    <!--</div>-->
    <!--<div class="back">-->
    <!--Back!-->
    <!--</div>-->
    <!--</div>-->
    <!--</div>-->
    <!--</div>-->



    <script src="https://cdn.jsdelivr.net/npm/alasql@0.4"></script>

    <!--todo: outdated version to get codepen I copied to work-->
    <!--<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
    <script src="d3.min.js" charset="utf-8"></script>
    <div  style="display: none"id="body">

    </div>


    <div style="display:flex;flex-direction:row;">

      <button class="btn btn-default" id="obtain-new-token">Factory Token Refresh</button>
      <button onclick="refreshToken()">refreshToken</button>
      <button onclick="forceToken()">forceToken</button>
      <button onclick="testAPI('playlistTracks')">testAPI playlistTracks</button>
      <button onclick="testAPI('artist')">testAPI artist</button>
      <button onclick="clean_cache()">clean_cache</button>

      <!--<button onclick="top_artists()">artists</button>-->

      <button onclick="load_playlists()">load_user_playlists</button>
      <button onclick="load_playlists_select()">load_playlists_select</button>

      <button onclick="search_artists()">search_artists</button>
    </div>

    <div ng-controller="myCtrl">

      <div style="display:flex;flex-direction:row;">
        <div>

          <div class="" >selected metro: {{global_metro}}</div>
          <div class="" > [YYYY-MM-DD] start date <input ng-model="dateFilter.start">  & end date <input ng-model="dateFilter.end"></div>
          <div class="" >raw_filename <input ng-model="raw_filename"></div>
          <div class="" >areaDatesArtists_filename <input ng-model="areaDatesArtists_filename"></div>

          <div class="" >select metro: <button style="color:red" ng-click="get_metro_events(global_metro)">get_metro_events</button> </div>

          <div style="display:flex;flex-direction:row;">
            <select ng-options="metro as metro.displayName for metro in metros" ng-model="global_metro"></select>
          </div>

        </div>

      </div><!--row-->


      <div style="display:flex;flex-direction:row;">

        <button ng-click="get_all_tracks(global_user,user_cache[global_user.id].selected)">getAllTracks</button>
        <button ng-click="get_user_playlists(global_user)">get_user_playlists</button>
        <button ng-click="set_user_cache()">set_user_cache</button>
        <button ng-click ="applyIt()">applyIt</button>
        <button ng-click ="testPost()">testPost</button>
        <div><button ng-click ="search_artists(artistSearch)">search_artists</button> <input ng-model="artistSearch"></div>
        <button class="btn btn-default" ng-click="testEndpoint()">testEndpoint</button>
      </div>

      <div>selected user: {{global_user.display_name}}</div>

      <div>select user:</div>
      <div style="display:flex;flex-direction:row;">

        <div style="display:flex;flex-direction:column;">

          <select ng-options="user as user.display_name for user in users" ng-model="global_user"></select>
          filter
          <button ng-click="shared['artists'] = !shared['artists']">shared artists</button>
          <button ng-click="shared['genres'] = !shared['genres']">shared genres</button>
          <button ng-click="testdb()">testdb</button>
          <button ng-click="genreSort === 'genreFreq' ? genreSort = 'genreGroup':{}">genreSort {{genreSort}}</button>

        </div>


        <!--todo: this should have some other condition besides playlists-->

        <div ng-if="user_cache[u.id]['playlists'].length >0" ng-repeat="u in users">
          {{u.display_name}}

          <div style="min-width:15em" ng-show="user_cache[u.id]">
            <div>
              <span class="pointer" ng-click="show[u.id]['playlists'] = !show[u.id]['playlists']">PLAYLISTS+</span>
              ({{user_cache[u.id]['playlists'].length}})

              <div ng-show="show[u.id]['playlists']" style="font-style:italic;"
                   ng-repeat="p in user_cache[u.id]['playlists']">&nbsp &nbsp {{p.name}}
              </div>

              SELECT
              <!--<button ng-click="setSelected(user_cache[global_user.id].selected,'all')">all</button>-->
              <!--<button  ng-click="setSelected(user_cache[global_user.id].selected,'none')">none</button>-->

              <!--<cfaes-multiobject ng-init="!user_cache[global_user.id].selected ? user_cache[global_user.id].selected = []:{}" -->
                                 <!--ng-model="user_cache[global_user.id].selected" selection="user_cache[u.id]['playlists']" order="displayOrder" ordering="false"-->
                                 <!--filterable="false" display="name" type="checkboxes">-->
              <!--</cfaes-multiobject>-->


            </div>

            <div>
              <span class="pointer"ng-click="show[u.id]['artists'] = !show[u.id]['artists']">ARTISTS+</span>
              ({{user_cache[u.id]['artists'].length}})

              <div  ng-if="show[u.id]['artists']" style="font-style:italic;"
                    ng-repeat="a in user_cache[u.id]['artists'] | orderByArtistFreq:artist_freq_map[u.id]">
                &nbsp &nbsp {{ a.name}} ({{artist_freq_map[u.id][a.artist_id]}})

              </div>
            </div>
            <!--| orderBy:'toString()' | sharedFilter:'artists':shared-->

            <div>
              <span class="pointer" ng-click="show[u.id]['genres'] = !show[u.id]['genres']">GENRES+</span>
              ({{user_cache[u.id]["genres"].length}})

              <!--| orderBy:genreFreq(u):descendFreq | sharedFilter:'genres':shared"-->

              <div  ng-if="show[u.id]['genres']" style="font-style:italic;"
                    ng-repeat="g in user_cache[u.id]['genres'] | orderByGenre:genreSort:genre_freq_map[u.id]:familyColor_map[g.family[0]]" >
                <!--ng-repeat="g in user_cache[u.id]['genres'] | orderByGenreFreq:genre_freq_map[u.id]" >-->
                &nbsp &nbsp {{g.name}}
                <span ng-style="{color:familyColor_map[g.family[0]]}">({{genreFam_map[g.name]}}) </span>
                <!--{{ genreFam_map[g.name][0]}}-->
                <!--{{familyColor_map[genreFam_map[g.name][0]]}}-->
                ({{genre_freq_map[u.id][g.genre_id]}})

                <!--<button ng-click="set_filterGenre(g)">({{genreEventMatches(g,global_metro)}})</button>-->
                <button ng-click="test = genres_frequency(g,u)">({{test}})</button>

              </div>
            </div>
            <div style="font-weight:bold;"> TRACKS: {{user_cache[u.id]["tracks"].length}} </div>

          </div>

        </div>

        <div>
          <!--| hasGenre:filterGenre:user_cache-->
          <div ng-repeat="e in metro_cache[global_metro.id] ">
            <div style="font-weight:bold">{{e.displayName}} @ {{e.venue.displayName}} on {{getEventDate(e)}}</div>

            <!--todo: this displayName belongs to the performance, not the artist performing-->
            <div>artists:
              <div ng-repeat="p in e.performances | getPerfs:e track by $index">{{p.displayName}}

                <!--<span ng-if="getGenres(p).length > 0">-->
                <!--(<span style="font-style:italic" ng-repeat="g in getGenres(p)"> {{g}}</span>)-->
              <!--</span>-->
                (<span style="font-style:italic" ng-repeat="g in p.genres | getGenres:p track by $index"> {{g}}</span>)
                <img style="max-width: 4em;" src="">

                <!--todo: doesn't work (no index?)-->
                {{$index}}
                <span ng-hide="$index = getPerfs(e).length - 1">,</span>
              </div>
              </span>
            </div>
          </div>
        </div>

      </div>

    </div>  <!--myCtrl-->

  </div>
</div>

<!--<script id="angular">-->

<!--var module = angular.module('playlistGen', [])-->
<!--var controller = module.controller("myCtrl", function($scope) {-->
<!--console.log("myCtrl");-->
<!--$scope.test = "test"-->


<!--})-->

<!--//$scope.config = widget.customization;-->

<!--</script>-->

<script id="user-profile-template" type="text/x-handlebars-template">
  <h1>Logged in as {{display_name}}</h1>
  <div class="media">
    <!--<div class="pull-left">-->
    <!--<img class="media-object" width="150" src="{{images.0.url}}" />-->
    <!--</div>-->
    <div class="media-body">
      <dl class="dl-horizontal">
        <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
        <dt>Id</dt><dd>{{id}}</dd>
        <dt>Email</dt><dd>{{email}}</dd>
        <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
        <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
        <!--<dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>-->
        <dt>Country</dt><dd>{{country}}</dd>
      </dl>
    </div>
  </div>
</script>

<script id="oauth-template" type="text/x-handlebars-template">
  <h2>oAuth info</h2>
  <dl class="dl-horizontal">
    <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
    <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}></dd>
  </dl>
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

<!---->
<!-- I use this to perform intial log in with Spotify, but not after-->
<!---->
<script>
	(function() {

		/**
		 * Obtains parameters from the hash of the URL
		 * @return Object
		 */
		function getHashParams() {
			var hashParams = {};
			var e, r = /([^&;=]+)=?([^&;]*)/g,
				q = window.location.hash.substring(1);
			while ( e = r.exec(q)) {
				hashParams[e[1]] = decodeURIComponent(e[2]);
			}
			return hashParams;
		}

		var userProfileSource = document.getElementById('user-profile-template').innerHTML,
			userProfileTemplate = Handlebars.compile(userProfileSource),
			userProfilePlaceholder = document.getElementById('user-profile');

		var oauthSource = document.getElementById('oauth-template').innerHTML,
			oauthTemplate = Handlebars.compile(oauthSource),
			oauthPlaceholder = document.getElementById('oauth');

		var params = getHashParams();

		var access_token = params.access_token,
			refresh_token = params.refresh_token,
			error = params.error;

		if (error) {
			alert('There was an error during the authentication');
		} else {
			if (access_token) {
				// render oauth info
				oauthPlaceholder.innerHTML = oauthTemplate({
					access_token: access_token,
					refresh_token: refresh_token
				});

				$.ajax({
					url: 'https://api.spotify.com/v1/me',
					headers: {
						'Authorization': 'Bearer ' + access_token
					},
					success: function(response) {
						userProfilePlaceholder.innerHTML = userProfileTemplate(response);

						$('#login').hide();
						$('#loggedin').show();
					}
				});
			} else {
				// render initial screen
				$('#login').show();
				$('#loggedin').hide();
			}

			document.getElementById('obtain-new-token').addEventListener('click', function() {
				$.ajax({
					url: '/refresh_token',
					data: {
						'refresh_token': refresh_token
					}
				}).done(function(data) {
					access_token = data.access_token;
					oauthPlaceholder.innerHTML = oauthTemplate({
						access_token: access_token,
						refresh_token: refresh_token
					});
				});
			}, false);
		}
	})();
</script>
</body>
</html>

